<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Run, jump, and fly through Base! Endless crypto runner adventure. Dodge bugs, glitches, rug pulls, and broken blocks. Collect Base tokens to unlock rocket mode and boost scores. Connect wallet for leaderboard, share achievements on social media. Fast-paced retro-style game built on Base blockchain. Join the race! üöÄ">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Base Runner - Endless Crypto Game</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        <div id="ui-overlay">
            <div id="score-display">Score: 0</div>
            <div id="high-score-display">High Score: 0</div>
            
            <!-- Wallet Connection UI -->
            <div id="wallet-ui">
                <button id="wallet-connect-btn" class="wallet-btn">Connect Wallet</button>
                <div id="wallet-info" style="display: none;">
                    <span id="wallet-address"></span>
                </div>
                <button id="wallet-disconnect-btn" class="wallet-btn" style="display: none;">Disconnect</button>
            </div>
            
            <div id="menu-screen" class="screen">
                <h1>Base Runner</h1>
                <p>Press <strong>SPACE</strong> or <strong>tap</strong> to jump/fly</p>
                <p class="instructions">Avoid obstacles and collect Base tokens!</p>
                <div id="wallet-menu-section">
                    <button id="wallet-connect-menu-btn" class="wallet-menu-btn">Connect Wallet</button>
                    <div id="wallet-info-menu" style="display: none;">
                        <span id="wallet-address-menu"></span>
                        <button id="wallet-disconnect-menu-btn" class="wallet-menu-btn-small">Disconnect</button>
                    </div>
                </div>
                <div class="button-group">
                    <button id="start-button">Start Game</button>
                    <button id="leaderboard-button" class="secondary-btn">Leaderboard</button>
                </div>
            </div>
            <div id="game-over-screen" class="screen hidden">
                <div class="game-over-content">
                    <div class="inspirational-message">
                        <p class="inspirational-text">Keep running, keep collecting, keep building!</p>
                        <p class="inspirational-subtext">Every run makes you stronger on Base.</p>
                    </div>
                    <div class="score-container">
                        <h2 class="game-over-title">Game Over</h2>
                        <p id="final-score" class="final-score-display">Final Score: 0</p>
                        <p id="high-score-badge" class="high-score-badge hidden">üèÜ New High Score! üèÜ</p>
                        <div class="share-icons-container">
                            <button id="share-x-button" class="share-icon-btn" title="Share on X">ùïè</button>
                            <button id="share-twitter-button" class="share-icon-btn" title="Share on Twitter">üê¶</button>
                            <button id="share-button" class="share-icon-btn" title="Share">üì§</button>
                        </div>
                    </div>
                    <div class="button-group">
                        <button id="restart-button">Play Again</button>
                        <button id="leaderboard-button-2" class="secondary-btn">Leaderboard</button>
                    </div>
                </div>
            </div>
            <div id="leaderboard-screen" class="screen hidden">
                <h2>Leaderboard</h2>
                <div id="leaderboard-content">
                    <div id="leaderboard-list"></div>
                </div>
                <button id="close-leaderboard">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Ethers.js for wallet connection -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/particles.js"></script>
    <script src="js/floatingText.js"></script>
    <script src="js/wallet.js"></script>
    <script src="js/input.js"></script>
    <script src="js/token.js"></script>
    <script src="js/obstacle.js"></script>
    <script src="js/player.js"></script>
    <script src="js/game.js"></script>
    <script>
        // Initialize game when page loads
        let game;
        let walletManager;
        
        // Wait for both DOM and all resources to load
        function initializeGame() {
            try {
                console.log('Initializing game...');
                console.log('Canvas element exists:', !!document.getElementById('game-canvas'));
                
                // Initialize wallet manager with error handling (continue even if it fails)
                try {
                    walletManager = new WalletManager();
                    console.log('Wallet manager initialized');
                } catch (walletError) {
                    console.warn('Wallet manager initialization failed (continuing without wallet):', walletError);
                    walletManager = null; // Continue without wallet
                }
                
                // Initialize game with error handling
                try {
                    const canvasElement = document.getElementById('game-canvas');
                    if (!canvasElement) {
                        throw new Error('Canvas element #game-canvas not found in DOM');
                    }
                    
                    console.log('Creating Game instance...');
                    game = new Game('game-canvas', walletManager);
                    console.log('Game instance created');
                    
                    console.log('Initializing game objects...');
                    game.init();
                    console.log('Game initialized successfully!');
                } catch (gameError) {
                    console.error('Game initialization failed:', gameError);
                    console.error('Stack trace:', gameError.stack);
                    // Show error in page instead of alert (which might not work on mobile)
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:red;color:white;padding:20px;z-index:9999;border-radius:10px;text-align:center;max-width:80%;';
                    errorDiv.innerHTML = '<h2>Game Initialization Error</h2><p>' + gameError.message + '</p><p style="font-size:12px;margin-top:10px;">Check console for details</p>';
                    document.body.appendChild(errorDiv);
                    return;
                }
                
                // Set up mobile behavior prevention AFTER game is initialized
                // Prevent scrolling during gameplay (only for game canvas)
                document.addEventListener('touchmove', (e) => {
                    if (game && game.state === 'playing') {
                        if (e.target.closest('#game-canvas') || e.target.closest('#game-container')) {
                            e.preventDefault();
                        }
                    }
                }, { passive: false });
                
                // Prevent pinch zoom only on game canvas
                document.addEventListener('gesturestart', (e) => {
                    if (e.target.closest('#game-canvas') || e.target.closest('#game-container')) {
                        e.preventDefault();
                    }
                });
                
                document.addEventListener('gesturechange', (e) => {
                    if (e.target.closest('#game-canvas') || e.target.closest('#game-container')) {
                        e.preventDefault();
                    }
                });
                
                document.addEventListener('gestureend', (e) => {
                    if (e.target.closest('#game-canvas') || e.target.closest('#game-container')) {
                        e.preventDefault();
                    }
                });
                
                // Prevent double-tap zoom on game canvas
                let lastTouchEnd = 0;
                document.addEventListener('touchend', (e) => {
                    if (e.target.closest('#game-canvas') || e.target.closest('#game-container')) {
                        const now = Date.now();
                        if (now - lastTouchEnd <= 300) {
                            e.preventDefault();
                        }
                        lastTouchEnd = now;
                    }
                }, { passive: false });
                
                // Handle orientation change on mobile
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        if (game && typeof game.handleResize === 'function') {
                            game.handleResize();
                        }
                    }, 100);
                });
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    if (game && typeof game.handleResize === 'function') {
                        game.handleResize();
                    }
                });
            
            // Wallet connection handlers (top-right)
            const connectBtn = document.getElementById('wallet-connect-btn');
            const disconnectBtn = document.getElementById('wallet-disconnect-btn');
            
            // Wallet connection handlers (menu)
            const connectMenuBtn = document.getElementById('wallet-connect-menu-btn');
            const disconnectMenuBtn = document.getElementById('wallet-disconnect-menu-btn');
            
            const leaderboardBtn = document.getElementById('leaderboard-button');
            const leaderboardBtn2 = document.getElementById('leaderboard-button-2');
            const closeLeaderboardBtn = document.getElementById('close-leaderboard');
            
                // Top-right wallet buttons
                if (connectBtn && walletManager) {
                    connectBtn.addEventListener('click', async () => {
                        try {
                            await walletManager.connect();
                        } catch (error) {
                            console.error('Wallet connect error:', error);
                        }
                    });
                }
                
                if (disconnectBtn && walletManager) {
                    disconnectBtn.addEventListener('click', () => {
                        try {
                            walletManager.disconnect();
                        } catch (error) {
                            console.error('Wallet disconnect error:', error);
                        }
                    });
                }
                
                // Menu wallet buttons
                if (connectMenuBtn && walletManager) {
                    connectMenuBtn.addEventListener('click', async () => {
                        try {
                            await walletManager.connect();
                        } catch (error) {
                            console.error('Wallet connect error:', error);
                        }
                    });
                }
                
                if (disconnectMenuBtn && walletManager) {
                    disconnectMenuBtn.addEventListener('click', () => {
                        try {
                            walletManager.disconnect();
                        } catch (error) {
                            console.error('Wallet disconnect error:', error);
                        }
                    });
                }
                
                if (leaderboardBtn && game) {
                    leaderboardBtn.addEventListener('click', () => {
                        if (game.showLeaderboard) {
                            game.showLeaderboard();
                        }
                    });
                }
                
                if (leaderboardBtn2 && game) {
                    leaderboardBtn2.addEventListener('click', () => {
                        if (game.showLeaderboard) {
                            game.showLeaderboard();
                        }
                    });
                }
                
                if (closeLeaderboardBtn && game) {
                    closeLeaderboardBtn.addEventListener('click', () => {
                        if (game.hideLeaderboard) {
                            game.hideLeaderboard();
                        }
                    });
                }
            } catch (initError) {
                console.error('Initialization error:', initError);
                console.error('Stack trace:', initError.stack);
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:red;color:white;padding:20px;z-index:9999;border-radius:10px;text-align:center;max-width:80%;';
                errorDiv.innerHTML = '<h2>Initialization Error</h2><p>' + initError.message + '</p><p style="font-size:12px;margin-top:10px;">Check console for details</p>';
                document.body.appendChild(errorDiv);
            }
        }
        
        // Try multiple load events for better mobile compatibility
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOMContentLoaded fired');
                setTimeout(initializeGame, 100); // Small delay for mobile browsers
            });
        } else {
            // DOM already loaded, run immediately with small delay
            console.log('DOM already loaded, initializing...');
            setTimeout(initializeGame, 100);
        }
        
        // Also wait for window load for external resources (backup)
        window.addEventListener('load', () => {
            console.log('Window load event fired');
            // Only initialize if not already done
            if (!game) {
                console.log('Game not initialized yet, initializing now...');
                setTimeout(initializeGame, 100);
            }
        });
        
        // Immediate fallback for mobile browsers that might not fire events correctly
        setTimeout(() => {
            if (!game) {
                console.log('Fallback initialization triggered');
                initializeGame();
            }
        }, 500);
    </script>
</body>
</html>
